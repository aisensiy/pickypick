"use strict";angular.module("pickypickApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","API"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/newmenu",{templateUrl:"views/menu-edit.html",controller:"MenuEditCtrl"}).when("/create-order/:menu_id",{templateUrl:"views/create-order.html",controller:"CreateOrderCtrl"}).when("/dish-stat/:menu_id",{templateUrl:"views/dish-stat.html",controller:"DishStatCtrl"}).when("/dish-detail/:menu_id",{templateUrl:"views/dish-detail.html",controller:"DishDetailCtrl"}).when("/order-created",{templateUrl:"views/order-created-message.html"}).otherwise({redirectTo:"/"})}]),angular.module("pickypickApp").controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("pickypickApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("pickypickApp").controller("MenuEditCtrl",["$rootScope","$scope","$location","DishAPI","MenuAPI",function(a,b,c,d,e){d.query(function(a){b.dishes=a}),b.new_dish={},b.selected={},b.menu={dishes:[]},b.add_new_dish=function(){e.add_dish_to_menu(b.menu,b.new_dish,function(){b.new_dish={}})},b.remove_dish=function(a){e.remove_dish_from_menu(b.menu,a,function(){delete b.selected[a.name]})},b.copy_to_menu=function(a){b.selected[a.name]||e.add_dish_to_menu(b.menu,a,function(){b.selected[a.name]=!0,console.log(b.menu)})},b.save_menu=function(){e.create(b.menu).success(function(b){e.set_cur_menu_id(b),c.path("/create-order/"+e.get_cur_menu_id()),a.$broadcast("menu:create")})}}]),angular.module("pickypickApp").controller("CreateOrderCtrl",["$location","$scope","MenuAPI","OrderAPI","$routeParams",function(a,b,c,d,e){b.total_price=0;var f=function(){b.total_price=0,b.dishes.forEach(function(a){b.total_price+=a.count*a.price})};b.order={},c.query(e.menu_id).success(function(a){b.menu=a,b.dishes=a.dishes,b.dishes.forEach(function(a){a.count=0})}),b.count_plus=function(a){a.count+=1,f()},b.count_minus=function(a){a.count<=0||(a.count-=1,f())},b.submit_order=function(c){c.menu=b.menu,d.create(c).success(function(){a.path("/order-created")})}}]),angular.module("pickypickApp").controller("DishStatCtrl",["$scope","OrderAPI","$routeParams",function(a,b,c){b.order_list(c.menu_id).success(function(b){var c=b.results;a.dish_stat={},a.total_price=0,angular.forEach(c,function(b){angular.forEach(b.dishes,function(c){var d="["+c.restaurant+"]"+c.name;a.dish_stat[d]?a.dish_stat[d].dishes.push(c):a.dish_stat[d]={dishes:[c],memos:{}},a.dish_stat[d].memos[b.memo]?a.dish_stat[d].memos[b.memo]+=1:b.memo&&(a.dish_stat[d].memos[b.memo]=1),a.total_price+=c.price})})})}]),angular.module("pickypickApp").controller("DishDetailCtrl",["$scope","OrderAPI","$routeParams",function(a,b,c){a.total_price=0,a.total_paid=0;var d=function(){a.total_paid=0,angular.forEach(a.orders,function(b){b.paid&&(a.total_paid+=b.total_price)})};b.order_list(c.menu_id).success(function(b){var c=b.results;a.orders=c,angular.forEach(a.orders,function(b){b.total_price=0,angular.forEach(b.dishes,function(c){a.total_price+=c.price,b.total_price+=c.price})}),d()}),a.update_order_pay_info=function(a){confirm("这尼玛不能乱改的哦，你确定吗")?b.update(a).success(function(){d()}):a.paid=!a.paid}}]);var api=angular.module("API",[]);api.run(["$http",function(a){a.defaults.headers.common["X-AVOSCloud-Application-Id"]="s7absgjlh4excjqd1arsfcn89baq9at1i6nckwy46kdek17g",a.defaults.headers.common["X-AVOSCloud-Application-Key"]="gs53oj7hti92uxr13mgzi47v9nv7hexjrc3982dqs4d3iq6b"}]),api.factory("DishAPI",function(){return{create:function(a,b){var c=AV.Object["new"]("Dish");console.log("create the dish and return it"),c.save(a,{success:function(a){b&&b(JSON.parse(JSON.stringify(a)))}})},query:function(a){var b=[{name:"香汁排骨饭汤套餐",price:29.5,restaurant:"真功夫"},{name:"冬菇鸡腿饭汤套餐",price:27,restaurant:"真功夫"},{name:"鱼香茄子饭汤套餐",price:20,restaurant:"真功夫"},{name:"排骨拼鸡腿肉饭汤套餐",price:30.5,restaurant:"真功夫"}];a&&a(b)}}}),api.factory("MenuAPI",["$http",function(a){return{create:function(b){return a.post("https://leancloud.cn/1.1/classes/Menu",b)},add_dish_to_menu:function(a,b,c){console.log("add dish to menu"),a.dishes.push(b),c&&c()},remove_dish_from_menu:function(a,b,c){for(var d=0;d<a.dishes.length;d++)if(b==a.dishes[d]){a.dishes.splice(d,1);break}console.log("remove dish in menu"),c&&c()},query:function(b){return a.get("https://leancloud.cn/1.1/classes/Menu/"+b)},set_cur_menu_id:function(a){localStorage.cur_menu_id=a.objectId},get_cur_menu_id:function(){return localStorage.cur_menu_id}}}]),api.factory("OrderAPI",["$http",function(a){return{create:function(b){var c=b.menu,d=[];return angular.forEach(c.dishes,function(a){a.count>0&&d.push(a)}),b.dishes=d,b.menu={__type:"Pointer",className:"Menu",objectId:c.objectId},console.log(b),a.post("https://leancloud.cn/1.1/classes/Order",b)},order_list:function(b){return a.get("https://leancloud.cn/1.1/classes/Order?"+encodeURI('where={"menu":{"__type":"Pointer","className":"Menu","objectId":"'+b+'"}}'))},update:function(b){return a.put("https://leancloud.cn/1.1/classes/Order/"+b.objectId,{paid:b.paid})}}}]),angular.module("pickypickApp").controller("NavBarCtrl",["$rootScope","$scope","MenuAPI",function(a,b,c){b.menu_id=c.get_cur_menu_id(),b.$on("menu:create",function(){b.menu_id=c.get_cur_menu_id()})}]),angular.module("pickypickApp").directive("dish",function(){return{templateUrl:"views/dish.html",restrict:"E",transclude:!0,scope:{dish:"="},link:function(){}}});